<!doctype html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css"><meta name="keywords" content="日志集中化,log collect,日志收集,rsyslog config,rsyslog配置"><link rel="alternate" href="/atom.xml" title="Karl's Notes" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0"><meta name="description" content="最近遇到一个需求，需要把线上环境的debug日志及集中化收集起来，一方面是方便开发调试；一方面是避免直接到线上环境查看，存在安全隐患。
常用可选方案：

rsyslog发送端 + rsyslog接收端： 直接存在接收端的本地硬盘
rsyslog发送端 + logstash接收端 + &amp;lt;后续第三方处理&amp;gt;： 接受到log更新行后，通过logstash简单处理后，可以继续往第三方处理，如放"><meta property="og:type" content="article"><meta property="og:title" content="日志集中化收集（一）：rsyslog 配置"><meta property="og:url" content="https://www.karlzhou.com/articles/center-log-with-rsyslog/index.html"><meta property="og:site_name" content="Karl's Notes"><meta property="og:description" content="最近遇到一个需求，需要把线上环境的debug日志及集中化收集起来，一方面是方便开发调试；一方面是避免直接到线上环境查看，存在安全隐患。
常用可选方案：

rsyslog发送端 + rsyslog接收端： 直接存在接收端的本地硬盘
rsyslog发送端 + logstash接收端 + &amp;lt;后续第三方处理&amp;gt;： 接受到log更新行后，通过logstash简单处理后，可以继续往第三方处理，如放"><meta property="og:image" content="https://www.karlzhou.com/images/center-log/collect-trash.jpg"><meta property="og:image" content="https://www.karlzhou.com/images/center-log/rsyslog-features-imagemap.png"><meta property="og:updated_time" content="2017-01-25T03:50:18.020Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="日志集中化收集（一）：rsyslog 配置"><meta name="twitter:description" content="最近遇到一个需求，需要把线上环境的debug日志及集中化收集起来，一方面是方便开发调试；一方面是避免直接到线上环境查看，存在安全隐患。
常用可选方案：

rsyslog发送端 + rsyslog接收端： 直接存在接收端的本地硬盘
rsyslog发送端 + logstash接收端 + &amp;lt;后续第三方处理&amp;gt;： 接受到log更新行后，通过logstash简单处理后，可以继续往第三方处理，如放"><meta name="twitter:image" content="https://www.karlzhou.com/images/center-log/collect-trash.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",sidebar:{position:"left",display:"post"},fancybox:!0,motion:!0,duoshuo:{userId:"6284895680469140000",author:"Root"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.karlzhou.com/articles/center-log-with-rsyslog/"><title> 日志集中化收集（一）：rsyslog 配置 | Karl's Notes</title></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-56188311-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?0ea6102e5274c5a948b3004a38a9b37a";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Karl's Notes</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-guestbook"><a href="/guestbook/" rel="section"><i class="menu-item-icon fa fa-fw fa-comments"></i><br> 留言</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup"><span class="search-icon fa fa-search"></span> <input type="text" id="local-search-input"><div id="local-search-result"></div> <span class="popup-btn-close">close</span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://www.karlzhou.com/articles/center-log-with-rsyslog/"><span style="display:none" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="Karl"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.jpg"></span><span style="display:none" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Karl's Notes"> <span style="display:none" itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject"><img style="display:none" itemprop="url image" alt="Karl's Notes" src=""></span></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 日志集中化收集（一）：rsyslog 配置</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-18T16:55:09+00:00">2016-12-18</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/DevOps/" itemprop="url" rel="index"><span itemprop="name">运维</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/articles/center-log-with-rsyslog/#comments" itemprop="discussionUrl"><span class="post-comments-count ds-thread-count" data-thread-key="articles/center-log-with-rsyslog/" itemprop="commentCount"></span></a></span> <span id="/articles/center-log-with-rsyslog/" class="leancloud_visitors" data-flag-title="日志集中化收集（一）：rsyslog 配置"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">热度</span><span>&nbsp;</span><span class="leancloud-visitors-count"></span> °C</span></div></header><div class="post-body" itemprop="articleBody"><p><img src="/images/center-log/collect-trash.jpg" alt="collect log"></p><p>最近遇到一个需求，需要把线上环境的debug日志及集中化收集起来，一方面是方便开发调试；一方面是避免直接到线上环境查看，存在安全隐患。</p><p>常用可选方案：</p><ol><li>rsyslog发送端 + rsyslog接收端： 直接存在接收端的本地硬盘</li><li>rsyslog发送端 + logstash接收端 + &lt;后续第三方处理&gt;： 接受到log更新行后，通过logstash简单处理后，可以继续往第三方处理，如放到ElasticSearch，或者放到消息队列Kfaka等</li><li>rsyslog发送端 + Splunk： Splunk是商业软件，也是业内用的比较多的方式，价格不菲</li></ol><a id="more"></a><p>基本原理和处理流程都是类似的： 监控本地log文件内容的变化，然后把变化的文件内容发送到远端收集服务上。<br>例如常说的<a href="https://www.gitbook.com/book/chenryn/elk-stack-guide-cn/details" rel="external nofollow noopener noreferrer" target="_blank">ELKstack</a>（ElasticSearch+Logstash+Kibana）的第一步都是配置rsyslog发送端。</p><p>不管哪种方案都得监控本地文件的变化，rsyslog属于必选。我们需求比较简单，暂时选用了落地到本地盘，默认存储15天debug日志。</p><p>本文主要介绍rsyslog发送端、接收端的配置，以及遇到的一些坑。</p><h1 id="rsyslog-简介"><a href="#rsyslog-简介" class="headerlink" title="rsyslog 简介"></a>rsyslog 简介</h1><p><a href="http://www.rsyslog.com/" rel="external nofollow noopener noreferrer" target="_blank">rsyslog</a> 在Linux上自带，兼容syslog语法，在syslog基础上增加了更多协议的支持，配合额外module插件可以完成很多场景的使用。借用下官网的图片：</p><p><img src="/images/center-log/rsyslog-features-imagemap.png" alt="rsyslog-features-imagemap"></p><p>注： Windows 平台需要 <a href="https://nxlog.co/" rel="external nofollow noopener noreferrer" target="_blank">nxlog</a> （nxlog 是用C 语言写的一个跨平台日志收集处理软件）。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在CentOS 6.8 Final 上自带的版本为 5.8.10。如需最新版本，可<a href="http://www.rsyslog.com/doc/v8-stable/installation/" rel="external nofollow noopener noreferrer" target="_blank">参考官网</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ rsyslogd -version</div><div class="line">rsyslogd 5.8.10, compiled with:</div><div class="line">        FEATURE_REGEXP:                         Yes</div><div class="line">        FEATURE_LARGEFILE:                      No</div><div class="line">        GSSAPI Kerberos 5 support:              Yes</div><div class="line">        FEATURE_DEBUG (debug build, slow code): No</div><div class="line">        32bit Atomic operations supported:      Yes</div><div class="line">        64bit Atomic operations supported:      Yes</div><div class="line">        Runtime Instrumentation (slow code):    No</div><div class="line"></div><div class="line">See http://www.rsyslog.com <span class="keyword">for</span> more information.</div></pre></td></tr></table></figure><p>V5版本开发于2010年，属于比较旧的版本，最新版本是V8，支持了更多的字符串处理函数和更多module，当然性能也更好。<br>缺点是：新旧配置语法不兼容，而采用内置版本的另一个偷懒的好处是云端的镜像也不需要再额外升级，能支持更多老机器。</p><p>后面介绍以V5版本为例，如有不同的，会单独指出。</p><h2 id="配置文件介绍"><a href="#配置文件介绍" class="headerlink" title="配置文件介绍"></a>配置文件介绍</h2><p>执行文件： <code>/sbin/rsyslogd</code><br>主配置文件: <code>/etc/rsyslog.conf</code><br>自定义配置文件: <code>/etc/rsyslog.d/*.conf</code><br>修改配置文件后，重启服务： <code>sudo /etc/init.d/rsyslog restart</code></p><p>一份配置文件主要包括以下几个部分：</p><ol><li>MODULES</li><li>RULES</li><li>全局指令，模板，模块参数等</li></ol><p>自带的配置文件如下，参考后面的注释：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"># rsyslog v5 configuration file</div><div class="line"></div><div class="line"># For more information see /usr/share/doc/rsyslog-*/rsyslog_conf.html</div><div class="line"># If you experience problems, see http://www.rsyslog.com/doc/troubleshoot.html</div><div class="line"></div><div class="line">#### MODULES ####	               # 模块放在开头加载</div><div class="line"></div><div class="line">$ModLoad imuxsock # provides support for local system logging (e.g. via logger command) # 可以用来调试，稍后有例子</div><div class="line">$ModLoad imklog   # provides kernel logging support (previously done by rklogd)</div><div class="line">#$ModLoad immark  # provides --MARK-- message capability</div><div class="line"></div><div class="line"># Provides UDP syslog reception</div><div class="line">#$ModLoad imudp</div><div class="line">#$UDPServerRun 514</div><div class="line"></div><div class="line"># Provides TCP syslog reception	   # TCP server，接收端需要加载这个模块，发送端不需要</div><div class="line">#$ModLoad imtcp</div><div class="line">#$InputTCPServerRun 514</div><div class="line"></div><div class="line"></div><div class="line">#### GLOBAL DIRECTIVES ####</div><div class="line"></div><div class="line"># Use default timestamp format</div><div class="line">$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat  # 消息格式</div><div class="line"></div><div class="line"># File syncing capability is disabled by default. This feature is usually not required,</div><div class="line"># not useful and an extreme performance hit</div><div class="line">#$ActionFileEnableSync on</div><div class="line"></div><div class="line">#### RULES ####				       # 用来指定哪种类型的，哪种级别的log，发送给谁处理</div><div class="line"></div><div class="line"># Log all kernel messages to the console.</div><div class="line"># Logging much else clutters up the screen.</div><div class="line"># kern.*                                                 /dev/console</div><div class="line"></div><div class="line"># Log anything (except mail) of level info or higher.</div><div class="line"># Don&apos;t log private authentication messages!</div><div class="line">*.info;mail.none;authpriv.none;cron.none                /var/log/messages</div><div class="line"></div><div class="line"># The authpriv file has restricted access.</div><div class="line">authpriv.*                                              /var/log/secure</div><div class="line"></div><div class="line"># Log all the mail messages in one place.</div><div class="line">mail.*                                                  -/var/log/maillog    # &apos;-&apos; 表示异步</div><div class="line"></div><div class="line"></div><div class="line"># Log cron stuff</div><div class="line">cron.*                                                  /var/log/cron</div><div class="line"></div><div class="line"># Everybody gets emergency messages</div><div class="line">*.emerg                                                 *</div><div class="line"></div><div class="line"># Save news errors of level crit and higher in a special file.</div><div class="line">uucp,news.crit                                          /var/log/spooler</div><div class="line"></div><div class="line"># Save boot messages also to boot.log</div><div class="line">local7.*                                                /var/log/boot.log	# local开头的是自定义的日志类型</div><div class="line"></div><div class="line"></div><div class="line"># ### begin forwarding rule ###</div><div class="line"># The statement between the begin ... end define a SINGLE forwarding</div><div class="line"># rule. They belong together, do NOT split them. If you create multiple</div><div class="line"># forwarding rules, duplicate the whole block!</div><div class="line"># Remote Logging (we use TCP for reliable delivery)</div><div class="line">#</div><div class="line"># An on-disk queue is created for this action. If the remote host is</div><div class="line"># down, messages are spooled to disk and sent when it is up again.</div><div class="line">#$WorkDirectory /var/lib/rsyslog # where to place spool files</div><div class="line">#$ActionQueueFileName fwdRule1 # unique name prefix for spool files</div><div class="line">#$ActionQueueMaxDiskSpace 1g   # 1gb space limit (use as much as possible)</div><div class="line">#$ActionQueueSaveOnShutdown on # save messages to disk on shutdown</div><div class="line">#$ActionQueueType LinkedList   # run asynchronously</div><div class="line">#$ActionResumeRetryCount -1    # infinite retries if host is down</div><div class="line"># remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional</div><div class="line">#*.* @@remote-host:514</div><div class="line"># ### end of the forwarding rule ###</div><div class="line"></div><div class="line"># Finally include all config files in /etc/rsyslog.d. This allows overrides</div><div class="line"># of the default configuration above.</div><div class="line">$IncludeConfig /etc/rsyslog.d/*.conf			# 这里会自动加载自定义的*.conf配置文件，可以覆盖默认参数</div></pre></td></tr></table></figure><h1 id="模块-imfile"><a href="#模块-imfile" class="headerlink" title="模块 imfile"></a>模块 imfile</h1><p>为了完成我们的任务，除了上面默认的模块，还需要加载 <code>imfile</code>，,来指定监控哪些文件，<a href="http://www.rsyslog.com/doc/v5-stable/configuration/modules/imfile.html" rel="external nofollow noopener noreferrer" target="_blank">参考文档</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ModLoad</span> imfile  <span class="comment"># Load the imfile input module</span></div></pre></td></tr></table></figure><p>该模块把标准的文本文件转换成syslog的message格式， 所谓标准文本是指：保护可打印的字符，每行以 <code>LF</code> 作为分隔符号。 支持文件正在在logrotate的时候，仍能正确处理。<br>它会把监控文件的读取到哪一个位置（类似游标cursor），存储在state文件里（由 <code>$WorkDirectory</code> 指定）。</p><p>该模块支持如下指令，一组如下设置，可以称为一个 <strong>listener</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$InputFileName</span> /path/to/file   <span class="comment"># 待监控的文件路径</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileTag</span> tag	<span class="comment"># 文件唯一标识tag，最好保持唯一，用于接收端区分原始log文件，可以包含特殊字符，如":"、","等</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileStateFile</span> /path/to/state/file</div><div class="line"><span class="comment"># 【重要】需要保证发送端唯一，记录读取到哪儿，状态文件保存在$WorkDirectory，默认为 /var/lib/rsyslog</span></div><div class="line"><span class="comment">#  如果某个要监控的文件名变化了，一定要重新设置该值</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileFacility</span> facility  <span class="comment"># log类型，默认local0， local开头的表示自定义类型</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileSeverity</span> severity	 <span class="comment"># log级别：info，warning，默认notice</span></div><div class="line"></div><div class="line"><span class="variable">$InputRunFileMonitor</span>		 <span class="comment"># 启动监控当前的文件，如果忘记这行，则啥事也不会发生</span></div><div class="line"></div><div class="line"><span class="variable">$InputFilePollInterval</span> seconds	<span class="comment"># 全局设置，默认轮询是10s</span></div><div class="line"></div><div class="line"><span class="variable">$InputFilePersistStateInterval</span> lines  <span class="comment"># 每多少行更新state文件状态</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileReadMode</span> mode   <span class="comment"># 官网竟然没这个解释，不过也没用到。。。</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileMaxLinesAtOnce</span> number	</div><div class="line"><span class="comment"># 默认10240，如果在发送端，需要同时监控多个文件，会处理完当前文件特定行后，切换到下一个文件，避免一个文件一直占用处理，导致收集别的文件不及时。</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileBindRuleset</span> ruleset  <span class="comment"># 属于较高级的设置，可以把这个listener绑定到特点的规则(http://www.rsyslog.com/doc/v5-stable/concepts/multi_ruleset.html)</span></div></pre></td></tr></table></figure><p>接收端配置，<strong>注意tag里的逗号 <code>&#39;,&#39;</code></strong>，稍后在接收端，会它来分隔：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># For product, total 19 files.</span></div><div class="line"></div><div class="line"><span class="variable">$InputFileName</span>  /Data/logs/product/cache-Statistic.log</div><div class="line"><span class="variable">$InputFileTag</span>   product,cache-Statistic	</div><div class="line"><span class="variable">$InputFileSeverity</span> info</div><div class="line"><span class="variable">$InputFileStateFile</span> state_product_cache-Statistic</div><div class="line"><span class="variable">$InputFilePersistStateInterval</span> 25000</div><div class="line"><span class="variable">$InputFileFacility</span> <span class="built_in">local</span>5</div><div class="line"><span class="variable">$InputRunFileMonitor</span></div></pre></td></tr></table></figure><p></p><h1 id="Rule-设置"><a href="#Rule-设置" class="headerlink" title="Rule 设置"></a>Rule 设置</h1><p>一条rule的语法格式如： <code>&lt;Facility&gt;.&lt;Severity&gt; &lt;Target&gt;</code><br>例如：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># Log cron stuff</div><div class="line">cron.*         /var/log/cron</div><div class="line"></div><div class="line"># 记录info到本地messages文件，.none 结尾表示排除掉这些文件类型。</div><div class="line">*.info;mail.none;authpriv.none;cron.none    /var/log/messages   </div><div class="line"></div><div class="line"># 所有为local5的任意级别日志发送到远端514</div><div class="line">local5.* @@192.168.56.10:514</div></pre></td></tr></table></figure><p></p><h2 id="Facility"><a href="#Facility" class="headerlink" title="Facility"></a>Facility</h2><p>日志设备(可以理解为日志类型):<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">auth         <span class="comment">#pam产生的日志，认证日志</span></div><div class="line">authpriv     <span class="comment">#ssh,ftp等登录信息的验证信息，认证授权认证</span></div><div class="line">cron         <span class="comment">#时间任务相关</span></div><div class="line">kern         <span class="comment">#内核</span></div><div class="line">lpr          <span class="comment">#打印</span></div><div class="line">mail         <span class="comment">#邮件</span></div><div class="line">mark(syslog) <span class="comment">#rsyslog服务内部的信息,时间标识</span></div><div class="line">news         <span class="comment">#新闻组</span></div><div class="line">user         <span class="comment">#用户程序产生的相关信息</span></div><div class="line">uucp         <span class="comment">#unix to unix copy, unix主机之间相关的通讯</span></div><div class="line"><span class="built_in">local</span> 1~7    <span class="comment">#自定义的日志设备</span></div></pre></td></tr></table></figure><p></p><h2 id="Severity"><a href="#Severity" class="headerlink" title="Severity"></a>Severity</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">debug           <span class="comment">#有调式信息的，日志信息最多</span></div><div class="line">info            <span class="comment">#一般信息的日志，最常用</span></div><div class="line">notice          <span class="comment">#最具有重要性的普通条件的信息</span></div><div class="line">warning, warn   <span class="comment">#警告级别</span></div><div class="line">err, error      <span class="comment">#错误级别，阻止某个功能或者模块不能正常工作的信息</span></div><div class="line">crit            <span class="comment">#严重级别，阻止整个系统或者整个软件不能正常工作的信息</span></div><div class="line">alert           <span class="comment">#需要立刻修改的信息</span></div><div class="line">emerg, panic    <span class="comment">#内核崩溃等严重信息</span></div></pre></td></tr></table></figure><h2 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h2><ul><li>文件： /var/log/messages</li><li>用户： root，*（表示所有用户）， 会发到/var/spool/mail/<user>收件箱里</user></li><li>日志服务器： @192.168.56.10 或者 @@192.168.56.10</li><li>管道： | COMMAND</li></ul><p>一个 <code>@</code> 表示 <code>UDP</code>, 两个 <code>@@</code> 表示 <code>TCP</code> 协议。</p><h1 id="常用指令"><a href="#常用指令" class="headerlink" title="常用指令"></a>常用指令</h1><h2 id="模板-template"><a href="#模板-template" class="headerlink" title="模板$template"></a>模板$template</h2><p>模板 <code>$template</code>， 最主要的一个指令，在 <strong>接收端</strong> 可用来定义消息格式、文件名。主要是在接收端使用。<br>可参考 <a href="http://www.rsyslog.com/doc/v5-stable/configuration/templates.html" rel="external nofollow noopener noreferrer" target="_blank">官方文档Templates</a></p><p>语法：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$template</span> &lt;name&gt;,&lt;内容&gt;,&lt;可选项&gt;</div><div class="line"><span class="variable">$template</span> MyTemplateName,<span class="string">"\7Text %property% some more text\n"</span>,&lt;options&gt;</div></pre></td></tr></table></figure><p></p><p>默认的消息格式 <code>RSYSLOG_TraditionalFileFormat</code><br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;接收内容的时间&gt;  &lt;发送者的hostname&gt;   &lt;<span class="variable">$InputFileTag</span>&gt; &lt;原始消息%msg%&gt;</div><div class="line">Dec 18 20:39:27 jumper-172-31-56-18 karltestdemoTag blala... dummy msg</div></pre></td></tr></table></figure><p></p><p>如果只需要显示原始消息，可设置<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$template</span> CleanMsgFormat,<span class="string">"%msg%\n"</span></div></pre></td></tr></table></figure><p></p><h2 id="内置属性-Properties"><a href="#内置属性-Properties" class="headerlink" title="内置属性 Properties"></a>内置属性 Properties</h2><p>模板里支持一些 <a href="http://www.rsyslog.com/doc/v5-stable/configuration/properties.html" rel="external nofollow noopener noreferrer" target="_blank">内置的变量</a>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">%msg%</div><div class="line">%syslogfacility%</div><div class="line">%HOSTNAME%</div><div class="line">%syslogpriority%</div><div class="line">%timereported:::date-mysql%</div><div class="line">%timegenerated:::date-mysql%</div><div class="line">%iut%</div><div class="line"><span class="string">'%syslogtag%'</span></div></pre></td></tr></table></figure><h2 id="属性处理-Property-Replacer"><a href="#属性处理-Property-Replacer" class="headerlink" title="属性处理 Property Replacer"></a>属性处理 Property Replacer</h2><p><a href="http://www.rsyslog.com/doc/v5-stable/configuration/property_replacer.html" rel="external nofollow noopener noreferrer" target="_blank">Property Replacer</a> 用来处理变量，支持一些简单的字符串处理，如大小写，substring等，类似jinja2的filter概念。<br>版本越新支持的处理函数越强大。<br>语法： <code>%property:fromChar:toChar:options%</code><br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># For product</span></div><div class="line"><span class="variable">$template</span> productFileFormat,<span class="string">"/Data/logs/product/%fromhost-ip%/%syslogtag:F,44:2%-%<span class="variable">$YEAR</span>%%<span class="variable">$MONTH</span>%%<span class="variable">$DAY</span>%.log"</span></div><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'product'</span> <span class="keyword">then</span> ?productFileFormat;CleanMsgFormat</div><div class="line">&amp; ~</div></pre></td></tr></table></figure><p></p><p>上面的例子，在接收端会保存为 <code>/Data/logs/product/198.168.56.123/karltest_demo-20161218.log</code></p><p>解释下这个指令<code>%syslogtag:F,44:2%</code></p><p><code>F,</code> - 代表自定义一个分隔符<br><code>44</code> - 是逗号 <code>,</code> 的 ASCII 码值，如需要别的分隔符，需要查对应 ASCII 值<br><code>2</code> - 取分隔后的第二个字段</p><p>所以就是： 假设发送端自定义的tag为 <code>$InputFileTag product,karltest_demo</code>，<br>如果tag以product开始，则取出逗号分隔的第二个字段作为保存的文件名，这也是为啥上面tag里要设置一个逗号的缘故。</p><p>另外，还支持一定的 regex 语法，可以进行更高级的控制。官方提供了一个<a href="http://www.rsyslog.com/regex/" rel="external nofollow noopener noreferrer" target="_blank">在线的 regex 语法测试</a>。<br><em>友情提醒：真的很难用。。。</em></p><h2 id="停止指令"><a href="#停止指令" class="headerlink" title="停止指令"></a>停止指令</h2><p>上面的接收端，在一条规则后，加上了如下的指令（也叫停止指令），代表如果log被当前的rule已经处理过了，则完成本次执行，跳过后续rule的处理。 <strong>类似 C++里 switch/case，如果忘记加break的穿透副作用</strong>。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&amp; ~</div></pre></td></tr></table></figure><p></p><p>如果没有这个指令，则一条新来的消息可以被多个rule处理。 这里我们并不需要，只要命中就保存到接收端同名的文件里。</p><h1 id="发送端配置"><a href="#发送端配置" class="headerlink" title="发送端配置"></a>发送端配置</h1><ol><li>加载 imfile 模块</li><li>指定要监控的 log 文件路径，设置合适的tag</li><li>指定远端的接收端的地址</li></ol><p>完整配置： <a href="/files/center-log/send-rsyslog-conf.txt">/etc/rsyslog.conf</a> 和 <a href="/files/center-log/send-rsyslogd-product-sample.txt">/etc/rsyslog.d/product.conf</a></p><h1 id="接收端配置"><a href="#接收端配置" class="headerlink" title="接收端配置"></a>接收端配置</h1><ol><li>加载 imtcp 模块</li><li>设置 message 格式</li><li>设置 文件存储路径，文件名格式</li></ol><p>完整配置： <a href="/files/center-log/recv-rsyslog-conf.txt">/etc/rsyslog.conf</a></p><h1 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h1><h2 id="UDP-or-TCP"><a href="#UDP-or-TCP" class="headerlink" title="UDP or TCP ?"></a>UDP or TCP ?</h2><p>一般来说选择TCP都是OK的，除非忍受部分丢失，在意影响性能，可以改用UDP。<br>但是注意：<strong>如果你的消息每行大小超过了4k，只能用TCP</strong>。这是因为UDP栈大小限制的。</p><p>引用官方有关 <a href="http://www.rsyslog.com/doc/v5-stable/configuration/global/index.html" rel="external nofollow noopener noreferrer" target="_blank">MaxMessageSize</a> 的描述：</p><blockquote><p> Note: testing showed that 4k seems to be the typical maximum for UDP based syslog. This is an IP stack restriction. Not always … but very often. If you go beyond that value, be sure to test that rsyslogd actually does what you think it should do ;) It is highly suggested to use a TCP based transport instead of UDP (plain TCP syslog, RELP). This resolves the UDP stack size restrictions.</p></blockquote><h2 id="如何测试：-vim-vs-echo"><a href="#如何测试：-vim-vs-echo" class="headerlink" title="如何测试： vim vs echo ?"></a>如何测试： vim vs echo ?</h2><p>配置好接收端、发送端rsyslog后，需要验证下是否能正确传送新的log行。</p><ol><li>echo追加： <code>echo &quot;dummy message&quot; &gt;&gt; /Data/logs/product/karltest.log</code></li><li>vim编辑： <code>vim /Data/logs/product/karltest.log</code></li></ol><p>用vim编辑后，保存会刷新整个文件，导致rsyslog在比较state file的时候，认为全部是新增的行，会在接收端出现重复的log行。<br>所以正确测试方法是用 echo 追加的方式。</p><blockquote><p>Tips:<br>发送端：可以配合 watch 来测试： <code>watch -n 1 &quot; echo $(date) dummy message &gt;&gt; /Data/logs/product/karltest.log &quot;</code><br> 接收端： <code>tailf /Data/logs/karltest/karltest.log</code></p></blockquote><h2 id="接收端：log行太长，被截断了"><a href="#接收端：log行太长，被截断了" class="headerlink" title="接收端：log行太长，被截断了"></a>接收端：log行太长，被截断了</h2><p>默认大小是2k，大概可以保存1000个中文字符，参考官方说明 <a href="http://www.rsyslog.com/doc/v5-stable/configuration/global/index.html" rel="external nofollow noopener noreferrer" target="_blank">$MaxMessageSize</a>， 最小也是2k。</p><p>在加载imtcp/imudp之前设置， <strong>此配置包括发送和接收，所以rsyslog客户端、服务端都要设置</strong>：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$MaxMessageSize</span> 32k</div><div class="line"></div><div class="line"><span class="comment"># Provides TCP syslog reception</span></div><div class="line"><span class="comment">#$ModLoad imtcp</span></div><div class="line"><span class="comment">#$InputTCPServerRun 514</span></div></pre></td></tr></table></figure><p></p><h2 id="发送端：-var-log-messages-文件变大"><a href="#发送端：-var-log-messages-文件变大" class="headerlink" title="发送端：/var/log/messages 文件变大"></a>发送端：/var/log/messages 文件变大</h2><p>log除了发送到了接收端，还在本地 <code>/var/log/messages</code> 里重复出现了，导致messages上G<br>罪魁祸首是默认的配置文件如下这行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 修改前</span></div><div class="line">*.info;mail.none;authpriv.none;cron.none                            /var/<span class="built_in">log</span>/messages      </div><div class="line"></div><div class="line"><span class="comment"># Fix后</span></div><div class="line">*.info;mail.none;authpriv.none;cron.none;<span class="built_in">local</span>5.none;<span class="built_in">local</span>6.none    /var/<span class="built_in">log</span>/messages</div></pre></td></tr></table></figure><p>因为前面有通配符 <code>*.info</code> 导致我们自定义的 <code>local5.info</code> 也会写到本地messages文件。<br><strong>为了保险，请把接收端、发送端的配置文件都修改掉，忽略掉local5。</strong></p><h2 id="接收端：消息被多个rule处理"><a href="#接收端：消息被多个rule处理" class="headerlink" title="接收端：消息被多个rule处理"></a>接收端：消息被多个rule处理</h2><p>在命中某条rule后，直接break停止</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'product'</span> <span class="keyword">then</span> ?productFileFormat;CleanMsgFormat</div><div class="line">&amp; ~</div><div class="line"></div><div class="line"><span class="comment"># 新版本v6之后，变为：</span></div><div class="line"><span class="comment"># rsyslogd: warning: ~ action is deprecated, consider using the 'stop' statement instead [try http://www.rsyslog.com/e/2307 ]</span></div><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'product'</span> <span class="keyword">then</span> ?productFileFormat;CleanMsgFormat</div><div class="line">stop</div></pre></td></tr></table></figure><h2 id="接收端：-保存的文件路径不对"><a href="#接收端：-保存的文件路径不对" class="headerlink" title="接收端： 保存的文件路径不对"></a>接收端： 保存的文件路径不对</h2><p>要注意自定义tag的前缀匹配，<strong>如果两个tag有共同的前缀，需要把长的放在前面</strong>，调整好顺序。</p><p>Fix 前：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># For erp_wms</span></div><div class="line"><span class="variable">$template</span> erp_wms_FileFormat,<span class="string">"/Data/logs/erp/wms/%fromhost-ip%/%syslogtag:F,44:2%-%<span class="variable">$YEAR</span>%%<span class="variable">$MONTH</span>%%<span class="variable">$DAY</span>%.log"</span></div><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'erp_wms'</span> <span class="keyword">then</span> ?erp_wms_FileFormat;CleanMsgFormat</div><div class="line">&amp; ~</div><div class="line"></div><div class="line"><span class="comment"># For erp_wms3</span></div><div class="line"><span class="variable">$template</span> erp_wms3_FileFormat,<span class="string">"/Data/logs/erp/wms3/%fromhost-ip%/%syslogtag:F,44:2%-%<span class="variable">$YEAR</span>%%<span class="variable">$MONTH</span>%%<span class="variable">$DAY</span>%.log"</span></div><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'erp_wms3'</span> <span class="keyword">then</span> ?erp_wms3_FileFormat;CleanMsgFormat</div><div class="line">&amp; ~</div></pre></td></tr></table></figure><p></p><p>Fix 后：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这里注意下面的tag的顺序， 一定要让长的tag（erp_wms3）保持在上面，因为他们有共同的前缀(erp_wms)</span></div><div class="line"><span class="comment"># For erp_wms3</span></div><div class="line"><span class="variable">$template</span> erp_wms3_FileFormat,<span class="string">"/Data/logs/erp/wms3/%fromhost-ip%/%syslogtag:F,44:2%-%<span class="variable">$YEAR</span>%%<span class="variable">$MONTH</span>%%<span class="variable">$DAY</span>%.log"</span></div><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'erp_wms3'</span> <span class="keyword">then</span> ?erp_wms3_FileFormat;CleanMsgFormat</div><div class="line">&amp; ~</div><div class="line"></div><div class="line"><span class="comment"># For erp_wms</span></div><div class="line"><span class="variable">$template</span> erp_wms_FileFormat,<span class="string">"/Data/logs/erp/wms/%fromhost-ip%/%syslogtag:F,44:2%-%<span class="variable">$YEAR</span>%%<span class="variable">$MONTH</span>%%<span class="variable">$DAY</span>%.log"</span></div><div class="line"><span class="keyword">if</span> <span class="variable">$syslogtag</span> startswith <span class="string">'erp_wms'</span> <span class="keyword">then</span> ?erp_wms_FileFormat;CleanMsgFormat</div><div class="line">&amp; ~</div></pre></td></tr></table></figure><p></p><h2 id="接收端：-rsyslog-文件名太长后被截断"><a href="#接收端：-rsyslog-文件名太长后被截断" class="headerlink" title="接收端： rsyslog 文件名太长后被截断"></a>接收端： rsyslog 文件名太长后被截断</h2><p>比如发送端原始文件名tag: <code>product，cache_status_im_request.log</code><br>但是到了接收端就截断了： <code>cache_status_im_re-20161218.log</code><br>因为本来名字就长，加上了时间后更长了，</p><p>个人理解，Linux中关于文件名（255），文件路径（4096）的限制如下，而在接收端，都没有超过这个长度。</p><pre><code>$ cat /usr/include/linux/limits.h

#ifndef _LINUX_LIMITS_H
#define _LINUX_LIMITS_H

#define NR_OPEN         1024

#define NGROUPS_MAX    65536    /* supplemental group IDs are available */
#define ARG_MAX       131072    /* # bytes of args + environ for exec() */
#define LINK_MAX         127    /* # links a file may have */
#define MAX_CANON        255    /* size of the canonical input queue */
#define MAX_INPUT        255    /* size of the type-ahead buffer */
#define NAME_MAX         255    /* # chars in a file name */
#define PATH_MAX        4096    /* # chars in a path name including nul */
#define PIPE_BUF        4096    /* # bytes in atomic write to a pipe */
#define XATTR_NAME_MAX   255    /* # chars in an extended attribute name */
#define XATTR_SIZE_MAX 65536    /* size of an extended attribute value (64k) */
#define XATTR_LIST_MAX 65536    /* size of extended attribute namelist (64k) */

#define RTSIG_MAX         32

#endif
</code></pre><p>进过一番艰难的测试复现，猜测是 <code>$InputFileTag</code> 这个 <code>%syslogtag%</code>的原因。</p><p>官方解释<a href="http://www.rsyslog.com/sende-messages-with-tags-larger-than-32-characters/" rel="external nofollow noopener noreferrer" target="_blank">Sending messages with tags larger than 32 characters</a>。</p><p>发送端默认的模板为：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 忽略旧的5.8.6的语法</span></div><div class="line">template (name=<span class="string">"ForwardFormat"</span> <span class="built_in">type</span>=<span class="string">"string"</span> string=<span class="string">"&lt;%PRI%&gt;%TIMESTAMP:::date-rfc3339% %HOSTNAME%</span></div><div class="line">%syslogtag:1:32%%msg:::sp-if-no-1st-sp%%msg%")</div></pre></td></tr></table></figure><p></p><p>可以看到 <code>%syslogtag:1:32%</code>，被截断到32字符，这个也与我测试的结果一致。</p><p>所以如果需要处理更长的tag，需要修改 发送端的template模板，去掉 <code>:1:32</code> 限制。<br>然后绑定这个模板到对应的target上。<br>注意：接收端可能也要相应处理，才能handle更长的tag名（未测试）。</p><blockquote><p>免责声明：由于折腾这个rsyslog太累，最后一条暂时没有Fix，如有需要，请自行测试后再用。</p></blockquote><p><em>UPDATED @ 2017-01-24</em><br>这个问题越来越严重，所以必须花时间解决掉。</p><p>如下的两个%syslogtag%，由于前32个字符都相同，导致最后日志写到同一个文件 <code>databas.log</code> (按照逗号切割后)了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$InputFileName</span>	/Data/logs/mqorder/order-mq-aws/database-stat.log</div><div class="line"><span class="variable">$InputFileTag</span>   erp_mqorder-order-mq-aws,database-stat		<span class="comment"># 长度39</span></div><div class="line">...</div><div class="line"><span class="variable">$InputFileName</span>	/Data/logs/mqorder/order-mq-aws/database-timeout.log</div><div class="line"><span class="variable">$InputFileTag</span>   erp_mqorder-order-mq-aws,database-timeout   <span class="comment"># 长度42</span></div><div class="line">...</div></pre></td></tr></table></figure><p> <strong>解决方法</strong> ：<br>在发送端的主配置文件 <code>/etc/rsyslog.conf</code>里修改发送规则：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ### begin forwarding rule ###</span></div><div class="line"><span class="variable">$template</span> LongTagForwardFormat,<span class="string">"&lt;%PRI%&gt;%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg%"</span></div><div class="line"><span class="variable">$WorkDirectory</span> /var/lib/rsyslog <span class="comment"># where to place spool files</span></div><div class="line"><span class="variable">$ActionQueueFileName</span> karlzhou_fwdRule           <span class="comment"># unique name prefix for spool files</span></div><div class="line"><span class="variable">$ActionQueueMaxDiskSpace</span> 5g                 <span class="comment"># 5gb space limit (use as much as possible)</span></div><div class="line"><span class="variable">$ActionQueueSaveOnShutdown</span> on               <span class="comment"># save messages to disk on shutdown</span></div><div class="line"><span class="variable">$ActionQueueType</span> LinkedList                 <span class="comment"># run asynchronously</span></div><div class="line"><span class="variable">$ActionResumeRetryCount</span> -1                  <span class="comment"># infinite retries if host is down</span></div><div class="line"><span class="built_in">local</span>5.* @@rsyslog.karlzhou.org:514;LongTagForwardFormat</div><div class="line"></div><div class="line"><span class="comment"># ### end of the forwarding rule ###</span></div></pre></td></tr></table></figure><p></p><p>其中起作用的就是 <code>LongTagForwardFormat</code> 这个模板。</p><p> <strong>解决过程</strong> ：</p><p>TL;DR</p><p>参考了上面的链接: 官方解释<a href="http://www.rsyslog.com/sende-messages-with-tags-larger-than-32-characters/" rel="external nofollow noopener noreferrer" target="_blank">Sending messages with tags larger than 32 characters</a> 和 <a href="http://help.papertrailapp.com/discussions/questions/458-tag-getting-truncated.html" rel="external nofollow noopener noreferrer" target="_blank">tag getting truncated</a>。</p><p>官方解释里是 5.8.6 的旧的语法，而CentOS6.x Final上自带的是 5.8.10， 语法不一样。<br>从官网下载5.8.10的源码: <a href="http://www.rsyslog.com/files/download/rsyslog/rsyslog-5.8.10.tar.gz" rel="external nofollow noopener noreferrer" target="_blank">http://www.rsyslog.com/files/download/rsyslog/rsyslog-5.8.10.tar.gz</a></p><p>全文搜索关键字 <code>%syslogtag</code>， 最终在如下几个文件找到蛛丝马迹：</p><ul><li>rsyslog-5.8.10/tools/smfwd.c</li><li>rsyslog-5.8.10/tools/smtradfile.c</li><li>rsyslog-5.8.10/tools/smtradfwd.c</li><li>rsyslog-5.8.10/tools/syslogd.c</li></ul><p>全文搜索关键字 <code>ForwardFormat</code>:</p><ul><li>rsyslog-5.8.10/tools/syslogd.c</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/* hardcoded standard templates (used <span class="keyword">for</span> defaults) */</div><div class="line">static uchar template_DebugFormat[] = <span class="string">"\"Debug line with all properties:\nFROMHOST: '%FROMHOST%', fromhost-ip: '%fromhost-ip%', HOSTNAME: '%HOSTNAME%', PRI: %PRI%,\nsyslogtag '%syslogtag%', programname: '%programname%', APP-NAME: '%APP-NAME%', PROCID: '%PROCID%', MSGID: '%MSGID%',\nTIMESTAMP: '%TIMESTAMP%', STRUCTURED-DATA: '%STRUCTURED-DATA%',\nmsg: '%msg%'\nescaped msg: '%msg:::drop-cc%'\ninputname: %inputname% rawmsg: '%rawmsg%'\n\n\""</span>;</div><div class="line">static uchar template_SyslogProtocol23Format[] = <span class="string">"\"&lt;%PRI%&gt;1 %TIMESTAMP:::date-rfc3339% %HOSTNAME% %APP-NAME% %PROCID% %MSGID% %STRUCTURED-DATA% %msg%\n\""</span>;</div><div class="line">static uchar template_TraditionalFileFormat[] = <span class="string">"=RSYSLOG_TraditionalFileFormat"</span>;</div><div class="line">static uchar template_FileFormat[] = <span class="string">"=RSYSLOG_FileFormat"</span>;</div><div class="line">static uchar template_ForwardFormat[] = <span class="string">"=RSYSLOG_ForwardFormat"</span>;</div><div class="line">static uchar template_TraditionalForwardFormat[] = <span class="string">"=RSYSLOG_TraditionalForwardFormat"</span>;</div><div class="line">static uchar template_WallFmt[] = <span class="string">"\"\r\n\7Message from syslogd@%HOSTNAME% at %timegenerated% ...\r\n %syslogtag%%msg%\n\r\""</span>;</div><div class="line">static uchar template_StdUsrMsgFmt[] = <span class="string">"\" %syslogtag%%msg%\n\r\""</span>;</div><div class="line">static uchar template_StdDBFmt[] = <span class="string">"\"insert into SystemEvents (Message, Facility, FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values ('%msg%', %syslogfacility%, '%HOSTNAME%', %syslogpriority%, '%timereported:::date-mysql%', '%timegenerated:::date-mysql%', %iut%, '%syslogtag%')\",SQL"</span>;</div><div class="line">static uchar template_StdPgSQLFmt[] = <span class="string">"\"insert into SystemEvents (Message, Facility, FromHost, Priority, DeviceReportedTime, ReceivedAt, InfoUnitID, SysLogTag) values ('%msg%', %syslogfacility%, '%HOSTNAME%', %syslogpriority%, '%timereported:::date-pgsql%', '%timegenerated:::date-pgsql%', %iut%, '%syslogtag%')\",STDSQL"</span>;</div><div class="line">static uchar template_spoofadr[] = <span class="string">"\"%fromhost-ip%\""</span>;</div><div class="line">/* end templates */</div></pre></td></tr></table></figure><p>正如官网链接所说，源码里 hardcoded 里多个默认模板格式，<br>其中我们需要关注的就是 <code>RSYSLOG_ForwardFormat</code>, 对应的文件即：<code>rsyslog-5.8.10/tools/smfwd.c</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/* smfwd.c</div><div class="line"> * This is a strgen module for the traditional (network) forwarding format.</div><div class="line"> *</div><div class="line"> * Format generated:</div><div class="line"> * &quot;&lt;%PRI%&gt;%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag:1:32%%msg:::sp-if-no-1st-sp%%msg%&quot;</div><div class="line"> *</div><div class="line"> * NOTE: read comments in module-template.h to understand how this file</div><div class="line"> *       works!</div><div class="line"> *</div><div class="line"> * File begun on 2010-06-01 by RGerhards</div><div class="line"> *</div></pre></td></tr></table></figure><p>这里，就能找到我们需要的正确的默认格式了, 可以看到 %syslogtag% 截取了前面32个字符，把ForwardFormat规则替换成完整的 %syslogtag% 即可，注意：最大的长度是512。</p><h1 id="接下来……"><a href="#接下来……" class="headerlink" title="接下来……"></a>接下来……</h1><p>通过一番设置，我们已经能成功收集若干台线上机器的日志了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tree -I "*gz|*log" /Data/logs/</span></div><div class="line">/Data/logs/</div><div class="line">├── gateway</div><div class="line">│   ├── 172.31.70.18</div><div class="line">│   │   └── archived</div><div class="line">│   ├── 172.31.70.19</div><div class="line">│   │   └── archived</div><div class="line">│   ├── 172.31.70.195</div><div class="line">│   │   └── archived</div><div class="line">│   ├── 172.31.70.197</div><div class="line">│   │   └── archived</div><div class="line">│   ├── 172.31.70.198</div><div class="line">│   │   └── archived</div><div class="line">│   └── 172.31.70.20</div><div class="line">│       └── archived</div><div class="line">├── product</div><div class="line">│   ├── 172.31.70.118</div><div class="line">│   │   └── archived</div><div class="line">│   ├── 172.31.70.119</div><div class="line">│   │   └── archived</div><div class="line">│   ├── 172.31.70.23</div><div class="line">│   │   └── archived</div><div class="line">│   └── 172.31.70.24</div><div class="line">│       └── archived</div><div class="line">...</div><div class="line"></div><div class="line"><span class="comment"># du -sh /Data/logs</span></div><div class="line">271G    /Data/logs</div></pre></td></tr></table></figure><p>那么问题来了：</p><blockquote><p>上百台机器的上几百G的日志，怎么才能避免接收端硬盘爆掉？</p></blockquote><p>得用另一个Linux自带的脚本 <code>/usr/sbin/logrotate</code>, 来配合 rsyslog。</p><p>请参考： <a href="/articles/center-log-with-logrotate/">日志集中化收集（二）：logrotate 配置</a></p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol><li><a href="http://www.rsyslog.com/doc/v5-stable/" rel="external nofollow noopener noreferrer" target="_blank">rsyslog官方v5版本文档</a></li><li><a href="http://www.rsyslog.com/doc/v5-stable/configuration/modules/imfile.html" rel="external nofollow noopener noreferrer" target="_blank">rsyslog imfile 模块</a></li><li><a href="http://www.rsyslog.com/doc/v5-stable/configuration/templates.html" rel="external nofollow noopener noreferrer" target="_blank">rsyslog Template</a></li><li><a href="http://www.rsyslog.com/doc/v5-stable/configuration/properties.html" rel="external nofollow noopener noreferrer" target="_blank">rsyslog 内置属性</a></li><li><a href="http://www.rsyslog.com/doc/v5-stable/configuration/property_replacer.html" rel="external nofollow noopener noreferrer" target="_blank">rsyslog 属性处理</a></li><li><a href="http://www.rsyslog.com/storing-messages-from-a-remote-system-into-a-specific-file/" rel="external nofollow noopener noreferrer" target="_blank">Storing Messages from a Remote System into a specific File</a></li><li><a href="http://www.rsyslog.com/writing-specific-messages-to-a-file-and-discarding-them/" rel="external nofollow noopener noreferrer" target="_blank">Writing specific messages to a file and discarding them</a></li><li><a href="http://www.rsyslog.com/sende-messages-with-tags-larger-than-32-characters/" rel="external nofollow noopener noreferrer" target="_blank">Sending messages with tags larger than 32 characters</a></li></ol></div><div></div><div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/Linux/" rel="tag"># Linux</a> <a href="/tags/DevOps/" rel="tag"># DevOps</a> <a href="/tags/Log/" rel="tag"># Log</a></div><div class="copyright"> <strong>本文链接:</strong> https://www.karlzhou.com/articles/center-log-with-rsyslog/<br> <strong>版权声明:</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/cn/" rel="external nofollow noopener noreferrer" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明出处！<br></div><div class="post-nav"><div class="post-nav-next post-nav-item"><h4>PREVIOUS POST</h4><a href="/2016/05/28/travis-ci-deploy-blog/" rel="next" title="用Travis CI自动部署Hexo博客"><i class="fa fa-chevron-left"></i> 用Travis CI自动部署Hexo博客</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><h4>NEXT POST</h4> <a href="/articles/summary-2016/" rel="prev" title="2016年终回顾">2016年终回顾<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div class="ds-thread" data-thread-key="articles/center-log-with-rsyslog/" data-title="日志集中化收集（一）：rsyslog 配置" data-url="https://www.karlzhou.com/articles/center-log-with-rsyslog/"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview"> 站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Karl"><p class="site-author-name" itemprop="name">Karl</p><p class="site-description motion-element" itemprop="description">If you can think differently, you can act differently. Just do IT!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zhoujiealex/" target="_blank" title="GitHub" rel="external nofollow noopener noreferrer"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://stackoverflow.com/users/1386591/zjalex/" target="_blank" title="StackOverflow" rel="external nofollow noopener noreferrer"><i class="fa fa-fw fa-stack-overflow"></i> StackOverflow</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://blog.jobbole.com/" title="伯乐在线" target="_blank" rel="external nofollow noopener noreferrer">伯乐在线</a></li><li class="links-of-blogroll-item"> <a href="http://toutiao.io/" title="开发者头条" target="_blank" rel="external nofollow noopener noreferrer">开发者头条</a></li><li class="links-of-blogroll-item"> <a href="http://www.appinn.com/" title="小众软件" target="_blank" rel="external nofollow noopener noreferrer">小众软件</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#rsyslog-简介"><span class="nav-number">1.</span> <span class="nav-text">rsyslog 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件介绍"><span class="nav-number">1.2.</span> <span class="nav-text">配置文件介绍</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模块-imfile"><span class="nav-number">2.</span> <span class="nav-text">模块 imfile</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rule-设置"><span class="nav-number">3.</span> <span class="nav-text">Rule 设置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Facility"><span class="nav-number">3.1.</span> <span class="nav-text">Facility</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Severity"><span class="nav-number">3.2.</span> <span class="nav-text">Severity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Target"><span class="nav-number">3.3.</span> <span class="nav-text">Target</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#常用指令"><span class="nav-number">4.</span> <span class="nav-text">常用指令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#模板-template"><span class="nav-number">4.1.</span> <span class="nav-text">模板$template</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内置属性-Properties"><span class="nav-number">4.2.</span> <span class="nav-text">内置属性 Properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#属性处理-Property-Replacer"><span class="nav-number">4.3.</span> <span class="nav-text">属性处理 Property Replacer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#停止指令"><span class="nav-number">4.4.</span> <span class="nav-text">停止指令</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#发送端配置"><span class="nav-number">5.</span> <span class="nav-text">发送端配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#接收端配置"><span class="nav-number">6.</span> <span class="nav-text">接收端配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#遇到的坑"><span class="nav-number">7.</span> <span class="nav-text">遇到的坑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#UDP-or-TCP"><span class="nav-number">7.1.</span> <span class="nav-text">UDP or TCP ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#如何测试：-vim-vs-echo"><span class="nav-number">7.2.</span> <span class="nav-text">如何测试： vim vs echo ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接收端：log行太长，被截断了"><span class="nav-number">7.3.</span> <span class="nav-text">接收端：log行太长，被截断了</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#发送端：-var-log-messages-文件变大"><span class="nav-number">7.4.</span> <span class="nav-text">发送端：/var/log/messages 文件变大</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接收端：消息被多个rule处理"><span class="nav-number">7.5.</span> <span class="nav-text">接收端：消息被多个rule处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接收端：-保存的文件路径不对"><span class="nav-number">7.6.</span> <span class="nav-text">接收端： 保存的文件路径不对</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#接收端：-rsyslog-文件名太长后被截断"><span class="nav-number">7.7.</span> <span class="nav-text">接收端： rsyslog 文件名太长后被截断</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#接下来……"><span class="nav-number">8.</span> <span class="nav-text">接下来……</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">9.</span> <span class="nav-text">参考链接</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2014 - <span itemprop="copyrightYear">2017</span><span class="with-love"><i class="fa fa-trophy"></i></span> <span class="author" itemprop="copyrightHolder"><a href="mailto:i@karlzhou.com">Karl</a></span> <span class="cc-license" itemprop="license"><a style="border:0;margin:0 5px;position:relative;top:2px;left:8px" href="https://creativecommons.org/licenses/by-nc-sa/4.0/cn/" target="_blank" rel="external nofollow noopener noreferrer"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></span> <span class="beian" style="margin-right:10px"><a href="http://www.miitbeian.gov.cn/" target="_blank" rel="external nofollow noopener noreferrer">&nbsp; 苏ICP备16056788号</a></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script><script type="text/javascript">var duoshuoQuery={short_name:"thinkdiffme"};!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.id="duoshuo-script",e.src="/js/src/duoshuo-embed.js",e.charset="UTF-8",(document.getElementById("footer")||document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="popoverlay">').css("overflow","hidden"),$(".popup").toggle()}var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path,searchFunc=function(e,t,a){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var c=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),r=document.getElementById(t),n=document.getElementById(a);r.addEventListener("input",function(){var e=0,t='<ul class="search-result-list">',a=this.value.trim().toLowerCase().split(/[\s\-]+/);n.innerHTML="",this.value.trim().length>1&&c.forEach(function(c){var r=!1,n=c.title.trim().toLowerCase(),o=c.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),s=decodeURIComponent(c.url),i=-1,l=-1,p=-1;if(""!=n&&a.forEach(function(e,t){i=n.indexOf(e),l=o.indexOf(e),(i>=0||l>=0)&&(r=!0,0==t&&(p=l))}),r){e+=1,t+="<li><a href='"+s+"' class='search-result-title'>"+n+"</a>";var h=c.content.trim().replace(/<[^>]+>/g,"");if(p>=0){var u=p-20,d=p+80;u<0&&(u=0),0==u&&(d=50),d>h.length&&(d=h.length);var f=h.substring(u,d);a.forEach(function(e){var t=new RegExp(e,"gi");f=f.replace(t,'<b class="search-keyword">'+e+"</b>")}),t+='<p class="search-result">'+f+"...</p>"}t+="</li>"}}),t+="</ul>",0==e&&(t='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==a&&(t='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),n.innerHTML=t}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(document).keydown(function(e){27==e.keyCode&&$(".popup-btn-close").click()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".popoverlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script><script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script><script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script><script type="text/javascript" src=""></script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script><script>AV.initialize("Hla639U7xDAWLJLhOqSgLhvy-gzGzoHsz","C8ubwzRtIYV9J5qA0wfjQBct")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html>